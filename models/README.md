# DB used for synchronization

* currently Postgres 9.3 running in localhost

## Models

* models can be autogenerated with [sequelize-auto](https://github.com/sequelize/sequelize-auto)
```bash
sequelize-auto -h $DB_HOST -d $DB_NAME -u $DB_USER -x $DB_PASS -e mysql -o modelsLatest
```
* check the produced models, there can be syntactical errors 

### Altering models

Use this [README](migrations/README.md) if you want to do any changes to models.

# Useful commands
```bash
# clone production DB instance
aws rds create-db-snapshot --db-instance-identifier hpsyncdb --db-snapshot-identifier syncdbdev-$(date +"%Y-%m-%d")
aws rds restore-db-instance-from-db-snapshot --db-snapshot-identifier syncdbdev-2016-12-21 --db-instance-identifier syncdbdev-2016-12-21
aws rds modify-db-instance --db-instance-identifier syncdbdev-2016-12-21 --backup-retention-period 0 --apply-immediately
aws rds delete-db-snapshot --db-snapshot-identifier syncdbdev2016-12-21

# post DB clone steps
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME --no-data > schema.sql # update schema

mysql -h $DB_HOST -P 3306 -u dbuser -p
mysql> CREATE DATABASE adminapi; # used by Vedran
mysql> TRUNCATE TABLE mz_members; # open passwords stored here
mysql> GRANT ALL PRIVILEGES ON hpsyncdb.* To 'julie'@'%' IDENTIFIED BY 'passwd';
mysql> GRANT ALL PRIVILEGES ON adminapi.* To 'vedran'@'%' IDENTIFIED BY 'passwd';
mysql> GRANT ALL PRIVILEGES ON hpsyncdb.* To 'vedran'@'%' IDENTIFIED BY 'passwd';

mysqldump -h $DB_HOST -P 3306 -u vedran -p adminapi < schema.sql

# extra command references
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME --no-data > schema.sql # export
mysql -u $DB_USER -f -D $DB_NAME < schema.sql # import
sqlt-graph -f MySQL -o schema.png -t png schema.sql # produces schema diagram (package SQL::Translator)
```